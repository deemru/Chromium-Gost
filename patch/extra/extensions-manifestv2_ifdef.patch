From de96bea8f58da46b7a8703b5821ec5403596e4e9 Mon Sep 17 00:00:00 2001
From: Dmitrii Pichulin <deem@deem.ru>
Date: Thu, 2 Oct 2025 13:20:20 +0300
Subject: [PATCH] extensions-manifestv2.patch (ifdef)

---
 .../api/developer_private/extension_info_generator.cc     | 2 ++
 chrome/browser/extensions/extension_management.cc         | 8 ++++++++
 .../browser/extensions/manifest_v2_experiment_manager.cc  | 7 ++++++-
 chrome/browser/ui/webui/extensions/extensions_ui.cc       | 2 +-
 extensions/common/extension.cc                            | 2 ++
 5 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/chrome/browser/extensions/api/developer_private/extension_info_generator.cc b/chrome/browser/extensions/api/developer_private/extension_info_generator.cc
index 916366c82d0b4..910d80f488776 100644
--- a/chrome/browser/extensions/api/developer_private/extension_info_generator.cc
+++ b/chrome/browser/extensions/api/developer_private/extension_info_generator.cc
@@ -600,6 +600,7 @@ void ExtensionInfoGenerator::FillExtensionInfo(const Extension& extension,
     info.controlled_info.emplace();
     info.controlled_info->text =
         l10n_util::GetStringUTF8(IDS_EXTENSIONS_INSTALL_LOCATION_ENTERPRISE);
+#if 0
   } else {
     // Create Safety Hub information for any non-enterprise extension.
     developer::SafetyCheckWarningReason warning_reason =
@@ -611,6 +612,7 @@ void ExtensionInfoGenerator::FillExtensionInfo(const Extension& extension,
           ExtensionSafetyCheckUtils::GetSafetyCheckWarningStrings(
               warning_reason, state);
     }
+#endif
   }
 
   bool is_enabled = state == developer::ExtensionState::kEnabled;
diff --git a/chrome/browser/extensions/extension_management.cc b/chrome/browser/extensions/extension_management.cc
index e3250a9d8fa8f..fc5f25c2fa62a 100644
--- a/chrome/browser/extensions/extension_management.cc
+++ b/chrome/browser/extensions/extension_management.cc
@@ -367,6 +367,9 @@ bool ExtensionManagement::IsAllowedManifestVersion(
     int manifest_version,
     const std::string& extension_id,
     Manifest::Type manifest_type) {
+#if 1
+      return true;
+#else
   bool enabled_by_default =
       !base::FeatureList::IsEnabled(
           extensions_features::kExtensionsManifestV3Only) ||
@@ -392,6 +395,7 @@ bool ExtensionManagement::IsAllowedManifestVersion(
              installation_mode == ManagedInstallationMode::kForced ||
              installation_mode == ManagedInstallationMode::kRecommended;
   }
+#endif
 }
 
 bool ExtensionManagement::IsAllowedManifestVersion(const Extension* extension) {
@@ -412,6 +416,9 @@ bool ExtensionManagement::IsExemptFromMV2DeprecationByPolicy(
     return false;
   }
 
+#if 1
+  return true;
+#else
   switch (global_settings_->manifest_v2_setting) {
     case internal::GlobalSettings::ManifestV2Setting::kDefault:
       // Default browser behavior. Not exempt.
@@ -432,6 +439,7 @@ bool ExtensionManagement::IsExemptFromMV2DeprecationByPolicy(
   }
 
   return false;
+#endif
 }
 
 bool ExtensionManagement::IsAllowedByUnpublishedAvailabilityPolicy(
diff --git a/chrome/browser/extensions/manifest_v2_experiment_manager.cc b/chrome/browser/extensions/manifest_v2_experiment_manager.cc
index ac66c7734f056..7bc6658bcb7ae 100644
--- a/chrome/browser/extensions/manifest_v2_experiment_manager.cc
+++ b/chrome/browser/extensions/manifest_v2_experiment_manager.cc
@@ -148,6 +148,7 @@ bool ManifestV2ExperimentManagerFactory::ServiceIsCreatedWithBrowserContext()
 
 // Determines the current stage of the MV2 deprecation experiments.
 MV2ExperimentStage CalculateCurrentExperimentStage() {
+#if 0
   // Return the "highest" stage that is currently active for the user.
   if (base::FeatureList::IsEnabled(
           extensions_features::kExtensionManifestV2Unsupported)) {
@@ -158,7 +159,7 @@ MV2ExperimentStage CalculateCurrentExperimentStage() {
           extensions_features::kExtensionManifestV2Disabled)) {
     return MV2ExperimentStage::kDisableWithReEnable;
   }
-
+#endif
   return MV2ExperimentStage::kWarning;
 }
 
@@ -192,6 +193,9 @@ PrefMap GetGlobalNoticeAcknowledgedPrefFor(
 // Returns true if legacy extensions should be disabled, looking at both
 // experiment stage and global state.
 bool ShouldDisableLegacyExtensions(MV2ExperimentStage stage) {
+#if 1
+  return false;
+#else
   if (g_allow_mv2_for_testing) {
     // We allow legacy MV2 extensions for testing purposes.
     return false;
@@ -204,6 +208,7 @@ bool ShouldDisableLegacyExtensions(MV2ExperimentStage stage) {
     case MV2ExperimentStage::kUnsupported:
       return true;
   }
+#endif
 }
 
 // Returns true if the given `stage` is one in which extension enablement should
diff --git a/chrome/browser/ui/webui/extensions/extensions_ui.cc b/chrome/browser/ui/webui/extensions/extensions_ui.cc
index 641f3b237049a..aeb3c3da04cc7 100644
--- a/chrome/browser/ui/webui/extensions/extensions_ui.cc
+++ b/chrome/browser/ui/webui/extensions/extensions_ui.cc
@@ -484,7 +484,7 @@ content::WebUIDataSource* CreateAndAddExtensionsSource(Profile* profile,
           extensions_features::kExtensionsMenuAccessControlWithPermittedSites));
   source->AddBoolean(
       "safetyHubThreeDotDetails",
-      base::FeatureList::IsEnabled(features::kSafetyHubThreeDotDetails));
+      false);
 
   // MV2 deprecation.
   auto* mv2_experiment_manager = ManifestV2ExperimentManager::Get(profile);
diff --git a/extensions/common/extension.cc b/extensions/common/extension.cc
index c5b49b633a364..6d4c6ddf16e62 100644
--- a/extensions/common/extension.cc
+++ b/extensions/common/extension.cc
@@ -101,6 +101,7 @@ bool IsManifestSupported(int manifest_version,
   // Supported versions are always safe.
   if (manifest_version >= kMinimumSupportedManifestVersion &&
       manifest_version <= kMaximumSupportedManifestVersion) {
+#if 0
     // Emit a warning for unpacked extensions on Manifest V2 warning that
     // MV2 is deprecated.
     if (type == Manifest::TYPE_EXTENSION && manifest_version == 2 &&
@@ -108,6 +109,7 @@ bool IsManifestSupported(int manifest_version,
         !g_silence_deprecated_manifest_version_warnings) {
       *warning = errors::kManifestV2IsDeprecatedWarning;
     }
+#endif
     return true;
   }
 
-- 

